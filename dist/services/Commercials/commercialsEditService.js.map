{"version":3,"sources":["../../../src/services/Commercials/commercialsEditService.ts","../../../src/prisma/index.ts","../../../src/utils/validationsServices/validationsCommercials.ts"],"sourcesContent":["import prismaClient from \"../../prisma\";\r\nimport { UploadedFile } from \"express-fileupload\"; \r\nimport { v2 as cloudinary, UploadApiResponse } from \"cloudinary\";\r\nimport { validationsCommercialsService } from \"../../utils/validationsServices/validationsCommercials\";\r\nimport { TypesAccess } from \"../../keys/typeAccess/typesAccess\";\r\nimport { Messages, MessagesError } from \"../../constants/messages.api\";\r\n\r\ninterface ICommercialsEditService {\r\n  id: string;\r\n  idUserOwner: string;\r\n  idTypeCommercial: string;\r\n  name: string;\r\n  description: string;\r\n  urlImageCommercial: UploadedFile | null;\r\n  urlSocialMediaCommercial: string;\r\n  positionOrder: number;\r\n  status?: boolean | null\r\n}\r\n\r\nclass CommercialsEditService {\r\n  async execute({\r\n    id,\r\n    idUserOwner,\r\n    name,\r\n    description,\r\n    positionOrder,\r\n    idTypeCommercial,\r\n    urlImageCommercial,\r\n    urlSocialMediaCommercial,\r\n    status\r\n  }: ICommercialsEditService) {\r\n\r\n    if(!id){\r\n        return {\r\n            data: {\r\n                message: \"Não foi possível prosseguir com esta ação, por favor envio o id do comercial para prosseguir\",\r\n                status: 403,\r\n            },\r\n        }\r\n    }\r\n    \r\n    const validationsCommercials = validationsCommercialsService({\r\n      idUserOwner,\r\n      name,\r\n      urlImageCommercial,\r\n      urlSocialMediaCommercial,\r\n    });\r\n\r\n    if (validationsCommercials) {\r\n      return validationsCommercials;\r\n    }\r\n\r\n    const userExists = await prismaClient.users.findFirst({\r\n      where: {\r\n        id: idUserOwner,\r\n      },\r\n    });\r\n\r\n    const typeCommercialExists = await prismaClient.typesCommercials.findFirst({\r\n        where: {\r\n          id: idTypeCommercial,\r\n        },\r\n    });\r\n\r\n    const commercialsExists = await prismaClient.commercials.findFirst({\r\n      where: {\r\n        id: id,\r\n      }\r\n    });\r\n\r\n    if(status !== null && (userExists.typeAccess === TypesAccess.Worker || userExists.typeAccess === TypesAccess.User || userExists.typeAccess === TypesAccess.Promoter)){\r\n        return {\r\n            data: {\r\n                message: \"Não foi possível prosseguir com esta ação, você não tem permissão para alterar o status do comercial\",\r\n                status: 403,\r\n              },  \r\n        }\r\n    }\r\n    if (!commercialsExists) {\r\n        return {\r\n          data: {\r\n            message: \"Não foi possível prosseguir com esta ação, este comercial não existe\",\r\n            status: 403,\r\n          },\r\n        };\r\n      }\r\n      \r\n    if (!typeCommercialExists) {\r\n        return {\r\n          data: {\r\n            message: \"Não foi possível prosseguir com esta ação, este tipo do comercial não existe\",\r\n            status: 403,\r\n          },\r\n        };\r\n    }\r\n\r\n    if (!userExists) {\r\n      return {\r\n        data: {\r\n          message: \"Não foi possível prosseguir com esta ação, usuário responsável não existe\",\r\n          status: 403,\r\n        },\r\n      };\r\n    }\r\n\r\n    try {\r\n      const idUrlImageCommercial = commercialsExists.idUrlImageCommercial;\r\n  \r\n      const resultFile: UploadApiResponse = await new Promise((resolve, reject) => {\r\n          cloudinary.uploader\r\n            .upload_stream(\r\n              {\r\n                public_id: `commercials/${idUrlImageCommercial}`,\r\n                overwrite: true,\r\n                folder: \"commercials\",\r\n              },\r\n              (err, result) => {\r\n                if (err) {\r\n                  return {\r\n                    data: {\r\n                      message: err,\r\n                      status: 500,\r\n                    },\r\n                  };\r\n                }\r\n                resolve(result);\r\n              }\r\n            )\r\n            .end(urlImageCommercial.data);\r\n        }\r\n      );\r\n\r\n      await prismaClient.commercials.update({\r\n        where: {\r\n            id: id,\r\n        },\r\n\r\n        data: {\r\n          idUserOwner: idUserOwner,\r\n          name: name,\r\n          description: description ? description : null,\r\n          idTypeCommercial: typeCommercialExists.id,\r\n          positionOrder: positionOrder ? positionOrder : null,\r\n          idUrlImageCommercial: idUrlImageCommercial ? idUrlImageCommercial : null,\r\n          urlImageCommercial: resultFile.url\r\n          ? resultFile.url\r\n          : null,\r\n          urlSocialMediaCommercial: resultFile ? resultFile.url : null,\r\n        },\r\n      });\r\n\r\n      return {\r\n        data: {\r\n          message: Messages.UpdateMessageSuccess,\r\n          status: 200,\r\n        },\r\n      };\r\n    } catch (err) {\r\n      return {\r\n        data: {\r\n          message: `${MessagesError.UpdateMessageError} ${err}`,\r\n          status: 500,\r\n        },\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\nexport { CommercialsEditService };\r\n","import { PrismaClient } from \"@prisma/client\";\r\n\r\nconst prismaClient = new PrismaClient()\r\n\r\nexport default prismaClient;\r\n","import { UploadedFile } from \"express-fileupload\";\r\n\r\ninterface IParamsCommercialsService {\r\n  idUserOwner: string;\r\n  name: string;\r\n  urlImageCommercial: UploadedFile | null,\r\n  urlSocialMediaCommercial: string,\r\n}\r\n\r\nexport const validationsCommercialsService = ({\r\n  name,\r\n  idUserOwner,\r\n  urlImageCommercial,\r\n  urlSocialMediaCommercial,\r\n}: IParamsCommercialsService) => {\r\n  if (!idUserOwner) {\r\n    return {\r\n      data: {\r\n        message:\r\n          \"Não foi possível realizar está ação, informe o id do usuário responsável\",\r\n        status: 400,\r\n      },\r\n    };\r\n  }\r\n \r\n  if (!name) {\r\n    return {\r\n      data: {\r\n        message: \"Não foi possível realizar está ação, Preencha o nome do comercial.\", \r\n        status: 400,\r\n      },\r\n    };\r\n  }\r\n\r\n  if (!urlImageCommercial) {\r\n    return {\r\n      data: {\r\n        message: \"Não foi possível realizar está ação, por favor envie a sua imagem comercial.\",  \r\n        status: 400,\r\n      },\r\n    };\r\n  }\r\n\r\n  if (!urlSocialMediaCommercial) {\r\n    return {\r\n      data: {\r\n        message: \"Não foi possível realizar está ação, por favor envie a sua url de midia para vinculo com comercial\",  \r\n        status: 400,\r\n      },\r\n    };\r\n  }\r\n};\r\n"],"mappings":"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","names":["cloudinary"]}